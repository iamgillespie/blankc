<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BlankC | Inventory Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>

<body class="bg-gray-50 text-gray-900 font-sans">

    <header class="bg-white border-b border-gray-200 py-4 px-8 flex justify-evenly items-center sticky top-0 z-10">
        <h1 class="text-xl font-bold tracking-tighter">BLANKC <span class="font-light text-gray-400">|
                INVENTORY</span>
        </h1>
        <div class="space-x-4 flex">
            <button onclick="syncFromGithub()"
                class="bg-blue-600 text-white px-4 py-2 text-sm font-medium hover:bg-blue-700 transition">
                Sync from GitHub
            </button>
            <button onclick="exportData()"
                class="border-2 border-black px-4 py-2 text-sm font-bold hover:bg-black hover:text-white transition">
                Download Updates
            </button>
            <button onclick="openHelp()" class="p-2 text-gray-400 hover:text-black transition" title="Instructions">
                <i data-lucide="help-circle"></i>
            </button>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-8">
        <div id="stats" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-white p-6 border border-gray-200 shadow-sm">
                <p class="text-xs uppercase tracking-widest text-gray-400 font-bold">Total Guitars</p>
                <h2 id="count-total" class="text-3xl font-bold">0</h2>
            </div>
            <div class="bg-white p-6 border border-gray-200 shadow-sm">
                <p class="text-xs uppercase tracking-widest text-gray-400 font-bold">In Stock</p>
                <h2 id="count-stock" class="text-3xl font-bold text-green-600">0</h2>
            </div>
            <button onclick="openModal()"
                class="bg-white p-6 border-2 border-dashed border-gray-300 flex items-center justify-center hover:border-black transition group">
                <span class="text-gray-400 group-hover:text-black font-bold">+ Add New Guitar</span>
            </button>
        </div>

        <div class="bg-white border border-gray-200 overflow-hidden shadow-sm">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 border-b border-gray-200">
                    <tr>
                        <th class="p-4 text-xs uppercase tracking-widest font-bold">Serial</th>
                        <th class="p-4 text-xs uppercase tracking-widest font-bold">Model/Header</th>
                        <th class="p-4 text-xs uppercase tracking-widest font-bold">Price</th>
                        <th class="p-4 text-xs uppercase tracking-widest font-bold">Status</th>
                        <th class="p-4 text-xs uppercase tracking-widest font-bold text-right">Actions</th>
                    </tr>
                </thead>
                <tbody id="inventory-list">
                </tbody>
            </table>
        </div>
    </main>

    <div id="editorModal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 p-4">
        <div class="bg-white w-full max-w-2xl max-h-[90vh] overflow-y-auto p-8 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 id="modalTitle" class="text-2xl font-bold italic">ADD GUITAR</h2>
                <button onclick="closeModal()" class="text-gray-400 hover:text-black">✕</button>
            </div>
            <form id="guitarForm" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1">Serial Number</label>
                        <input type="text" id="field-serial"
                            class="w-full border border-gray-300 p-2 focus:border-black outline-none"
                            placeholder="e.g. BG-XXXVI" required>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1">Item Header</label>
                        <input type="text" id="field-header"
                            class="w-full border border-gray-300 p-2 focus:border-black outline-none" required>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase mb-1">Short Description</label>
                    <input type="text" id="field-short"
                        class="w-full border border-gray-300 p-2 focus:border-black outline-none">
                </div>
                <div>
                    <label class="block text-xs font-bold uppercase mb-1 text-gray-500">Description</label>
                    <div class="border border-gray-300 overflow-hidden">
                        <div class="bg-gray-100 border-b border-gray-300 p-2 flex space-x-2">
                            <button type="button" onclick="formatDoc('bold')"
                                class="px-3 py-1 bg-white border border-gray-300 text-xs font-bold hover:bg-black hover:text-white transition"
                                title="Bold">B</button>
                            <button type="button" onclick="formatDoc('italic')"
                                class="px-3 py-1 bg-white border border-gray-300 text-xs font-bold hover:bg-black hover:text-white transition"
                                title="Italic">I</button>
                            <button type="button" onclick="formatDoc('insertUnorderedList')"
                                class="px-2 py-1 bg-white border border-gray-300 text-xs font-bold hover:bg-black hover:text-white transition"
                                title="Bullet List">• List</button>
                            <button type="button" onclick="formatDoc('removeFormat')"
                                class="px-2 py-1 bg-white border border-gray-300 text-xs font-bold hover:bg-black hover:text-white transition"
                                title="Clear Styles">Clear</button>
                        </div>
                        <div id="field-html-editor" contenteditable="true"
                            class="w-full min-h-[200px] p-4 focus:outline-none bg-white prose prose-sm max-w-none">
                            <p></p>
                        </div>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1">Price ($)</label>
                        <input type="number" id="field-price"
                            class="w-full border border-gray-300 p-2 focus:border-black outline-none">
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1">Status</label>
                        <select id="field-sold"
                            class="w-full border border-gray-300 p-2 focus:border-black outline-none">
                            <option value="false">Available</option>
                            <option value="true">Sold</option>
                        </select>
                    </div>
                </div>

                <div class="border-t border-gray-100 pt-4">
                    <label class="block text-xs font-bold uppercase mb-1">Add Images (Converts to Base64)</label>
                    <input type="file" id="imageInput" multiple accept="image/*" class="w-full text-sm">
                    <div id="imagePreview" class="grid grid-cols-4 gap-2 mt-4"></div>
                </div>

                <div class="pt-6 flex justify-end space-x-4">
                    <button type="button" onclick="closeModal()"
                        class="px-6 py-2 font-bold uppercase text-sm">Cancel</button>
                    <button type="submit"
                        class="bg-black text-white px-8 py-2 font-bold uppercase text-sm hover:bg-gray-800 transition">Save
                        Guitar</button>
                </div>
            </form>
        </div>
    </div>
    <div id="download-zone"
        class="fixed bottom-0 left-0 right-0 bg-white border-t-4 border-black p-4 shadow-[0_-10px_15px_-3px_rgba(0,0,0,0.1)] transform translate-y-full transition-transform duration-300 z-40">
        <div class="max-w-6xl mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
            <div>
                <h3 class="text-sm font-black uppercase tracking-widest flex items-center">
                    <span class="inline-block w-2 h-2 bg-red-500 rounded-full mr-2 animate-pulse"></span>
                    Pending Updates
                </h3>
                <p class="text-xs text-gray-500">The following files have changes that need to be saved.</p>
            </div>

            <div id="file-list" class="flex flex-wrap gap-2 flex-grow px-4">
            </div>

            <div class="flex gap-2">
                <button onclick="clearQueue()"
                    class="text-xs font-bold uppercase px-4 py-2 hover:bg-gray-100 transition">Clear List</button>
                <button onclick="downloadAll()"
                    class="bg-black text-white px-6 py-2 text-sm font-black uppercase hover:bg-gray-800 transition shadow-lg">
                    Download All Files
                </button>
            </div>
        </div>
    </div>



    <!-- Help modal -->
    <div id="helpModal" class="fixed inset-0 bg-black/80 hidden items-center justify-center z-[60] p-4">
        <div class="bg-white w-full max-w-2xl p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black italic uppercase italic">How to Update the Shop</h2>
                <button onclick="closeHelp()" class="text-gray-400 hover:text-black text-2xl">✕</button>
            </div>

            <div class="space-y-6 text-sm leading-relaxed">
                <section>
                    <h3 class="font-bold uppercase border-b border-gray-200 pb-1 mb-2">1. Save Your Changes</h3>
                    <p>Once you finish editing a guitar or re-ordering photos, look at the **bottom of the screen**.
                        Click **"Download All Files"**. These will go to your computer's "Downloads" folder.</p>
                </section>

                <section>
                    <h3 class="font-bold uppercase border-b border-gray-200 pb-1 mb-2">2. Upload to GitHub</h3>
                    <p>Open your GitHub repository in your browser. You will need to upload files to **two specific
                        places**:</p>

                    <div class="bg-gray-50 p-4 border-l-4 border-black font-mono text-[11px] my-4">
                        <p class="font-bold text-black mb-2 uppercase italic text-xs">// FOLDER STRUCTURE</p>
                        <div class="flex items-center text-blue-600 font-bold">
                            <i data-lucide="folder" class="w-3 h-3 mr-2"></i> blankc (Main Folder)
                        </div>
                        <div class="ml-6 flex items-center text-gray-700">
                            <i data-lucide="file-json" class="w-3 h-3 mr-2"></i> inventory_data.json <span
                                class="ml-2 text-[10px] text-red-500 font-black">← DROP HERE</span>
                        </div>
                        <div class="ml-6 mt-2 flex items-center text-blue-600 font-bold">
                            <i data-lucide="folder" class="w-3 h-3 mr-2"></i> guitars
                        </div>
                        <div class="ml-12 flex items-center text-gray-700 italic">
                            <i data-lucide="file-json" class="w-3 h-3 mr-2"></i> [serial]-images.json <span
                                class="ml-2 text-[10px] text-red-500 font-black">← DROP INSIDE HERE</span>
                        </div>
                    </div>
                </section>

                <section>
                    <h3 class="font-bold uppercase border-b border-gray-200 pb-1 mb-2 text-red-600 italic underline">
                        Crucial Instruction</h3>
                    <ul class="list-disc ml-5 space-y-2">
                        <li><strong>inventory_data.json:</strong> This file must stay in the main (parent) folder.</li>
                        <li><strong>Image Files:</strong> Any file ending in <code>-images.json</code> MUST be uploaded
                            into the <strong>guitars</strong> folder.</li>
                    </ul>
                </section>

                <section>
                    <h3 class="font-bold uppercase border-b border-gray-200 pb-1 mb-2">3. GitHub Guide</h3>
                    <p>If you aren't sure how to use the GitHub website to upload, click the link below for the official
                        guide:</p>
                    <a href="https://docs.github.com/en/repositories/working-with-files/managing-files/adding-a-file-to-a-repository#adding-a-file-to-a-repository-on-github"
                        target="_blank"
                        class="inline-block mt-2 bg-black text-white px-4 py-2 font-bold uppercase text-[10px] tracking-widest hover:bg-gray-800 transition">
                        Open GitHub Upload Guide
                    </a>
                </section>
            </div>

            <button onclick="closeHelp()"
                class="w-full mt-8 border-2 border-black py-3 font-black uppercase text-sm hover:bg-black hover:text-white transition">
                I Understand
            </button>
        </div>
    </div>
    <script>
        const GITHUB_CONFIG = {
            username: 'iamgillespie',
            repo: 'blankc',
            branch: 'main',
            inventoryPath: 'inventory_data.json',
            guitarsFolder: 'guitars'
        };

        let inventory = [];
        let guitarImages = {};
        let editingSerial = null;
        let sortableInstance = null;
        let pendingDownloads = new Set();

        // --- EDITOR HELPERS ---
        function formatDoc(cmd, value = null) {
            document.execCommand(cmd, false, value);
            document.getElementById('field-html-editor').focus();
        }

        document.getElementById('field-html-editor').addEventListener('focus', function () {
            if (this.innerHTML.trim() === "" || this.innerHTML.trim() === "<br>") {
                this.innerHTML = '<p><br></p>';
            }
        });

        // --- QUEUE MANAGEMENT ---
        function addToQueue(filename) {
            pendingDownloads.add(filename);
            renderDownloadQueue();
        }

        function renderDownloadQueue() {
            const zone = document.getElementById('download-zone');
            const list = document.getElementById('file-list');
            if (pendingDownloads.size > 0) {
                zone.classList.remove('translate-y-full');
            } else {
                zone.classList.add('translate-y-full');
            }
            list.innerHTML = '';
            pendingDownloads.forEach(file => {
                const badge = document.createElement('div');
                badge.className = "flex items-center bg-gray-100 border border-gray-300 pl-3 pr-1 py-1 text-[10px] font-bold font-mono";
                badge.innerHTML = `
            ${file}
            <button onclick="individualDownload('${file}')" class="ml-2 p-1 hover:bg-black hover:text-white transition text-gray-500">
                <i data-lucide="download" class="w-3 h-3"></i>
            </button>
        `;
                list.appendChild(badge);
            });
            lucide.createIcons();
        }

        function clearQueue() {
            pendingDownloads.clear();
            renderDownloadQueue();
        }

        // --- DOWNLOAD LOGIC ---
        function individualDownload(filename) {
            if (filename === 'inventory_data.json') {
                downloadJson(inventory, 'inventory_data.json');
            } else {
                const serial = filename.replace('-images.json', '');
                if (guitarImages[serial]) {
                    downloadJson(guitarImages[serial], filename);
                }
            }
            pendingDownloads.delete(filename);
            renderDownloadQueue();
        }

        async function downloadAll() {
            const files = Array.from(pendingDownloads);
            for (const file of files) {
                individualDownload(file);
                await new Promise(resolve => setTimeout(resolve, 500));
            }
        }

        function downloadJson(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // --- GITHUB SYNC ---
        async function syncFromGithub(isAutoLoad = false) {
            const cacheBuster = `?t=${Date.now()}`;
            const url = `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.inventoryPath}${cacheBuster}`;

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('File not found');
                inventory = await response.json();
                renderInventory();
                if (!isAutoLoad) alert("Synced from GitHub!");
            } catch (error) {
                console.error("Sync error:", error.message);
                if (!isAutoLoad) alert("Sync error: " + error.message);
            }
        }

        async function fetchGuitarImages(serial) {
            if (guitarImages[serial]) return;
            const cacheBuster = `?t=${Date.now()}`;
            const url = `https://raw.githubusercontent.com/${GITHUB_CONFIG.username}/${GITHUB_CONFIG.repo}/${GITHUB_CONFIG.branch}/${GITHUB_CONFIG.guitarsFolder}/${serial}-images.json${cacheBuster}`;

            try {
                const response = await fetch(url);
                if (response.ok) {
                    guitarImages[serial] = await response.json();
                    renderImagePreviews(serial);
                }
            } catch (e) { console.log("No images on GitHub for " + serial); }
        }

        // --- RENDERING ---
        function renderInventory() {
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';

            inventory.forEach((item, index) => {
                const row = document.createElement('tr');
                row.className = "border-b border-gray-100 hover:bg-gray-50 transition";
                row.innerHTML = `
            <td class="p-4 font-mono text-sm font-bold">${item.serial}</td>
            <td class="p-4 font-medium">${item.itemHeader}</td>
            <td class="p-4">$${item.price}</td>
            <td class="p-4 text-xs uppercase font-bold ${item.isSold ? 'text-red-500' : 'text-green-600'}">${item.isSold ? 'Sold' : 'Available'}</td>
            <td class="p-4 text-right">
                <button onclick="editGuitar('${item.serial}')" class="text-blue-600 font-bold text-xs uppercase mr-4">Edit</button>
                <button onclick="deleteGuitar(${index})" class="text-red-600 font-bold text-xs uppercase">Delete</button>
            </td>
        `;
                list.appendChild(row);
            });

            document.getElementById('count-total').innerText = inventory.length;
            document.getElementById('count-stock').innerText = inventory.filter(i => !i.isSold).length;
        }

        function renderImagePreviews(serial) {
            const container = document.getElementById('imagePreview');
            container.innerHTML = '';
            const images = guitarImages[serial] || [];

            images.forEach((img, idx) => {
                const div = document.createElement('div');
                div.className = "relative group aspect-square border border-gray-200 overflow-hidden bg-gray-100 cursor-move";
                div.setAttribute('data-id', idx);
                div.innerHTML = `
            <img src="${img}" class="object-cover w-full h-full pointer-events-none">
            <button type="button" onclick="removeImg('${serial}', ${idx})" 
                class="absolute inset-0 bg-black/60 text-white opacity-0 group-hover:opacity-100 transition flex items-center justify-center text-xs font-bold uppercase">Remove</button>
        `;
                container.appendChild(div);
            });

            if (sortableInstance) sortableInstance.destroy();
            sortableInstance = new Sortable(container, {
                animation: 150,
                onEnd: () => {
                    const newOrder = [];
                    container.querySelectorAll('[data-id]').forEach(el => {
                        const oldIndex = parseInt(el.getAttribute('data-id'));
                        newOrder.push(images[oldIndex]);
                    });
                    guitarImages[serial] = newOrder;
                    addToQueue(`${serial}-images.json`);
                    renderImagePreviews(serial);
                }
            });
        }

        // --- MODAL CONTROLS ---
        function openModal() {
            editingSerial = null;
            document.getElementById('modalTitle').innerText = "ADD NEW GUITAR";
            document.getElementById('guitarForm').reset();
            document.getElementById('field-html-editor').innerHTML = '<p></p>';
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('editorModal').classList.remove('hidden');
            document.getElementById('editorModal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('editorModal').classList.add('hidden');
            document.getElementById('editorModal').classList.remove('flex');
            document.getElementById('guitarForm').reset();
            document.getElementById('field-html-editor').innerHTML = '';
        }

        // --- CRUD ---
        function editGuitar(serial) {
            const item = inventory.find(i => i.serial === serial);
            editingSerial = serial;
            document.getElementById('field-serial').value = item.serial;
            document.getElementById('field-header').value = item.itemHeader;
            document.getElementById('field-short').value = item.shortDescription;
            document.getElementById('field-price').value = item.price;
            document.getElementById('field-sold').value = item.isSold.toString();
            document.getElementById('field-html-editor').innerHTML = item.descriptionHTML || '<p></p>';
            document.getElementById('modalTitle').innerText = "EDIT GUITAR";
            document.getElementById('editorModal').classList.remove('hidden');
            document.getElementById('editorModal').classList.add('flex');
            fetchGuitarImages(serial);
            renderImagePreviews(serial);
        }

        document.getElementById('guitarForm').onsubmit = function (e) {
            e.preventDefault();
            const serial = document.getElementById('field-serial').value;
            const guitarData = {
                serial: serial,
                itemHeader: document.getElementById('field-header').value,
                shortDescription: document.getElementById('field-short').value,
                keywords: document.getElementById('field-header').value.toLowerCase().split(' '),
                price: parseInt(document.getElementById('field-price').value) || 0,
                isSold: document.getElementById('field-sold').value === 'true',
                descriptionHTML: document.getElementById('field-html-editor').innerHTML,
                imageFileJson: `${serial}-images.json`
            };
            if (editingSerial) {
                const idx = inventory.findIndex(i => i.serial === editingSerial);
                inventory[idx] = guitarData;
                if (editingSerial !== serial) {
                    guitarImages[serial] = guitarImages[editingSerial];
                    delete guitarImages[editingSerial];
                    addToQueue(`${editingSerial}-images.json`);
                }
            } else {
                inventory.push(guitarData);
            }
            addToQueue('inventory_data.json');
            addToQueue(`${serial}-images.json`);
            renderInventory();
            closeModal();
        };

        function deleteGuitar(index) {
            if (confirm("Permanently delete this guitar?")) {
                inventory.splice(index, 1);
                addToQueue('inventory_data.json');
                renderInventory();
            }
        }

        // --- IMAGE PROCESSING & UPLOAD ---

        /**
         * Resizes and compresses an image before returning Base64
         */
        async function processImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 1200;
                        let width = img.width;
                        let height = img.height;

                        // Only scale if it's wider than our limit
                        if (width > MAX_WIDTH) {
                            height *= MAX_WIDTH / width;
                            width = MAX_WIDTH;
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        // Convert to compressed JPEG (0.7 quality)
                        const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(dataUrl);
                    };
                };
            });
        }

        document.getElementById('imageInput').addEventListener('change', async function (e) {
            const files = Array.from(e.target.files);
            const serial = document.getElementById('field-serial').value;
            if (!serial) return alert("Enter Serial First");
            if (!guitarImages[serial]) guitarImages[serial] = [];

            for (const file of files) {
                // Process, resize, and compress each image
                const compressedBase64 = await processImage(file);
                guitarImages[serial].push(compressedBase64);
                renderImagePreviews(serial);
                addToQueue(`${serial}-images.json`);
            }
        });

        function removeImg(serial, idx) {
            guitarImages[serial].splice(idx, 1);
            addToQueue(`${serial}-images.json`);
            renderImagePreviews(serial);
        }

        // --- HELP MODAL ---
        function openHelp() {
            document.getElementById('helpModal').classList.remove('hidden');
            document.getElementById('helpModal').classList.add('flex');
        }
        function closeHelp() {
            document.getElementById('helpModal').classList.add('hidden');
            document.getElementById('helpModal').classList.remove('flex');
        }

        // --- AUTOMATION: Page Load Logic ---
        window.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            syncFromGithub(true);
        });
    </script>
</body>

</html>